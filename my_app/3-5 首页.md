# 3-5 首页（HomePage）

> **文档层级**：第 3 层 — 用户前端页面文档
> **文件名**：`docs/3-frontend/3-5-首页.md`
> **通用依赖**：`1-1 视觉设计语言文档`（色彩/排版/动画/响应式全屏适配规范）、`1-2 前端共享组件库文档`（可复用组件/Hooks/缓存策略）
> **额外依赖**：`2-2 用户模块`（用户信息/余额三字段）、`2-4 投资与结算模块`（今日收益/累计收益/活跃投资概览）、`2-8 VIP 等级模块`（VIP 状态/VIP0 每日领取）、`2-12 站内信模块`（消息未读数/WebSocket 推送）、`2-13 CMS 内容管理模块`（公告弹窗/滚动公告/动态文案/虚假播报）、`2-16 系统配置模块`（全局开关/首页布局配置/快捷入口/WebSocket 事件）
> **引用开发文档**：§10.2 页面 5、补充一 S1.1~S1.6、补充四 S4.8
> **谁需要读**：用户前端开发者
> **对应路由**：`/home`（已认证，第 1 个 Tab）
> **JTBD**：
> - **功能任务**：首页是信息中枢——余额/收益/VIP 状态/公告/快捷入口/投资概览，所有核心信息一屏尽览。WebSocket 实时更新余额。
> - **情感任务**：用户每天打开 App 第一眼看到「今日收益 +S/ XX」的数字从粒子聚合成型，满足感拉满——"我的钱又生了钱"。BalanceCard 的 3D 翻转切换可用/冻结/赠金，让用户感受到"我对每一分钱都有掌控感"。
> - **社会任务**：VIP 徽章+消息角标展示用户在平台的"身份地位"。滚动播报「XXX 获得 S/ XXX」营造"很多人在赚钱"的社交氛围。

---

## 目录

1. [页面职责](#一页面职责)
2. [弹窗系统](#二弹窗系统)
3. [顶部状态栏](#三顶部状态栏)
4. [余额卡片 BalanceCard](#四余额卡片-balancecard)
5. [今日收益 / 累计收益](#五今日收益--累计收益)
6. [VIP0 每日领取按钮](#六vip0-每日领取按钮)
7. [快捷入口网格](#七快捷入口网格)
8. [活跃投资概览](#八活跃投资概览)
9. [滚动公告栏](#九滚动公告栏)
10. [WebSocket 余额实时刷新](#十websocket-余额实时刷新)
11. [区块可见性控制逻辑](#十一区块可见性控制逻辑)
12. [完整组件树与数据流架构](#十二完整组件树与数据流架构)
13. [响应式布局策略](#十三响应式布局策略)
14. [骨架屏与加载策略](#十四骨架屏与加载策略)
15. [性能预算](#十五性能预算)
16. [自检清单](#十六自检清单)

---

## 一、页面职责

### 1.1 三条主线交汇点

首页是 BAE Systems 用户端的**信息中枢**，三条核心业务主线在此交汇：

| 主线 | 首页承载的信息 | 用户心理 |
| --- | --- | --- |
| **资金线** | 可用余额 / 冻结余额 / 赠金余额 / 今日收益 / 累计收益 | "我有多少钱？今天赚了多少？" |
| **投资线** | 活跃投资概览（产品名/进度/日收入）/ 快捷入口→产品页 | "我的钱在哪里工作？还有什么可以投？" |
| **社交线** | VIP 徽章 / 消息角标 / 滚动播报 / 邀请入口 | "我在平台是什么身份？别人也在赚钱吗？" |

### 1.2 3 秒法则

用户打开首页后，**3 秒内必须回答最核心的问题**——「今天赚了多少钱？」

**视觉流动路径**（F 型扫描 → 自然引导）：

```
① 余额大数字（text-amount-lg 28px，DM Mono，最大最亮）
   ↓ 目光自然下移
② 今日收益（text-positive 翠绿 + 柔光 text-shadow，ParticleNumber 粒子聚合抓眼球）
   ↓ 继续下移
③ 快捷操作入口（充值/提现/邀请/收益日历，紧凑网格，手指自然触达）
   ↓ 继续滚动
④ 投资概览（ProgressRing 环形进度，信息密度增大）
   ↓ 持续流动
⑤ 滚动播报（文字渐入渐出，永不停歇的"社交证明"）
```

### 1.3 信息层级与视觉权重

| 层级 | 内容 | 视觉权重 | 字号/色彩 | 占比 |
| --- | --- | --- | --- | --- |
| **第一层**（最高） | 余额 + 今日收益 | 最大最亮 | `text-amount-lg` 28px DM Mono + `text-positive` 翠绿柔光 | ~35% 首屏面积 |
| **第二层** | 快捷入口 + VIP 状态 | 中等权重 | `text-h3` 16px + Lucide 图标 24px + 金色 VIP 徽章 | ~25% 首屏面积 |
| **第三层**（最低） | 投资概览 + 滚动播报 | 辅助信息 | `text-body` 14px + `text-caption` 12px + `text-text-secondary` | ~40%（需滚动） |

### 1.4 空间节奏

由疏到密再到流动的节奏感：

```
┌─ 余额区 ──────────────────── 大面积呼吸留白，视觉"深呼吸" ─┐
│  BalanceCard 3D 翻转，内边距 24px，区块间距 32px            │
├─ 快捷入口 ────────────────── 紧凑网格，高效触达 ────────────┤
│  2×2 / 2×3 网格，图标 + 文字，间距 16px                     │
├─ 投资概览 ────────────────── 信息密集，环形进度 ────────────┤
│  ProgressRing 48px + 产品名/进度文字，间距 12px              │
├─ 滚动播报 ────────────────── 持续流动，永不停歇 ────────────┤
│  单行文字渐入渐出，高度 40px，无限循环                        │
└──────────────────────────────────────────────────────────────┘
```

---

## 二、弹窗系统

### 2.1 弹窗优先级排队机制

首页进入时可能同时存在多个弹窗，**严格按优先级依次展示**，不叠加、不并行：

| 优先级 | 弹窗类型 | 触发条件 | 数据来源 | 关闭后行为 |
| --- | --- | --- | --- | --- |
| **P1（最高）** | 每日首页公告弹窗 | 每日首次进入首页 + 后台有 `DAILY_POPUP` 类型公告 `isActive=true` 且在生效时间内 | `GET /api/cms/announcements?type=DAILY_POPUP` | 关闭后检查 P2 |
| **P2** | 活动 2（折扣产品）弹窗 | `discount_popup_enabled=true` **且**至少有一个折扣产品上架且倒计时未结束 | `GET /api/config/client` → `activitySwitches.discountPopupEnabled` + `GET /api/products?type=DISCOUNT&status=ACTIVE` | 关闭后无更多弹窗 |

### 2.2 弹窗排队状态机

```typescript
// src/pages/Home/hooks/usePopupQueue.ts

interface PopupQueueState {
  queue: PopupItem[];             // 待展示弹窗队列（已按优先级排序）
  currentPopup: PopupItem | null; // 当前展示的弹窗
  isProcessing: boolean;
}

type PopupItem =
  | { type: 'DAILY_POPUP'; data: Announcement }
  | { type: 'DISCOUNT_POPUP'; data: DiscountProduct[] };

// 流程：
// 1. 首页 mount → 并行请求公告 + 配置 + 折扣产品
// 2. 根据数据构建弹窗队列（P1 在前）
// 3. 每日公告判重：localStorage key = `popup:daily:${userId}:${today}`
//    - 已展示 → 跳过，检查下一个
//    - 未展示 → 展示，关闭后标记已展示
// 4. 当前弹窗关闭 → 200ms 延迟 → 展示队列下一个
// 5. 队列清空 → isProcessing = false
```

### 2.3 弹窗视觉规范

基于 `GlassModal` 组件（`1-2 §7.1`）：

| 属性 | 值 | 说明 |
| --- | --- | --- |
| **遮罩** | `bg-overlay backdrop-blur-[8px]` z-30 | 半透明遮罩（`rgba(15,23,42,0.4)`） |
| **内容卡片** | `bg-card shadow-card border border-card-border rounded-radius-xl shadow-modal` | 云端浮卡居中 |
| **移动端（< md）** | 底部 Sheet：从底部上滑，`rounded-t-radius-xl`，max-h `85vh`，拖拽关闭（下拉>40%） | `1-2 §7.1` 响应式变体 |
| **平板/桌面（≥ md）** | 居中弹窗：`max-w-[480px] rounded-radius-xl`，遮罩点击关闭 | 居中卡片样式 |
| **进入动画** | 遮罩 `opacity 0→1 0.3s`，内容 `scale(0.95)→scale(1) + opacity 0→1 0.3s ease-snappy`（居中）/ `translateY(100%)→translateY(0)`（底部 Sheet） | Framer Motion |
| **退出动画** | 内容 `scale(1)→scale(0.95) + opacity 1→0 0.2s`（居中）/ `translateY(0)→translateY(100%)`（底部 Sheet），遮罩 `opacity 1→0 0.2s` | Framer Motion |
| **关闭方式** | 右上角 `X` 按钮（Lucide `X` 20px）+ 遮罩点击关闭（居中）/ 拖拽下滑关闭（底部 Sheet） | `showClose=true closeOnOverlay=true` |

### 2.4 每日公告弹窗（P1）内容结构

```tsx
<GlassModal open={showDailyPopup} onClose={handleCloseDailyPopup} showClose closeOnOverlay>
  {/* 可选：顶部图片 */}
  {announcement.imageUrl && (
    <LazyImage
      src={announcement.imageUrl}
      alt={announcement.title}
      className="w-full max-h-[240px] object-cover rounded-t-radius-xl"
    />
  )}

  {/* 标题 */}
  <h3 className="text-h2 font-semibold text-text-primary mt-5 px-6">
    {announcement.title}
  </h3>

  {/* 富文本内容（DOMPurify 消毒 §7.21） */}
  <div className="px-6 mt-3 max-h-[300px] overflow-y-auto">
    <SafeHtmlRenderer htmlContent={announcement.content} />
  </div>

  {/* 可选：CTA 按钮 */}
  {announcement.ctaText && (
    <div className="px-6 pb-6 mt-5">
      <PrimaryButton width="full" onClick={() => announcement.ctaAction?.()}>
        {announcement.ctaText}
      </PrimaryButton>
    </div>
  )}
</GlassModal>
```

### 2.5 活动 2 折扣弹窗（P2）内容结构

```tsx
<GlassModal open={showDiscountPopup} onClose={handleCloseDiscountPopup} showClose closeOnOverlay>
  {/* 标题 */}
  <div className="px-6 pt-6">
    <h3 className="text-h2 font-semibold text-text-primary">
      {t('home.discount_popup_title')}
    </h3>
    <p className="text-body text-text-secondary mt-2">
      {t('home.discount_popup_desc')}
    </p>
  </div>

  {/* 折扣产品缩略列表（最多 3 个） */}
  <div className="px-6 mt-4 flex flex-col gap-3">
    {discountProducts.slice(0, 3).map(product => (
      <BreathBorder key={product.id} active>
        <GlassCard padding="sm" interactive onClick={() => navigate(`/products/${product.id}`)}>
          <div className="flex items-center justify-between">
            <span className="text-h3 font-semibold text-text-primary">{product.name}</span>
            <div className="text-right">
              <span className="text-caption text-text-secondary line-through">
                S/ {product.originalDailyIncome}
              </span>
              <span className="text-amount-sm font-mono text-positive ml-2">
                S/ {product.dailyIncome}
              </span>
            </div>
          </div>
        </GlassCard>
      </BreathBorder>
    ))}
  </div>

  {/* CTA */}
  <div className="px-6 pb-6 mt-5">
    <PrimaryButton width="full" onClick={() => navigate('/products')}>
      {t('home.discount_popup_cta')}
    </PrimaryButton>
  </div>
</GlassModal>
```

---

## 三、顶部状态栏

### 3.1 组件引用

使用 `TopStatusBar`（`1-2 §3.1`），首页专属顶部栏。

### 3.2 布局结构

```
┌──────────────────────────────────────────────┐
│  [VIP 徽章]                        [ 角标] │
│  VIP2 ✦                              3      │
└──────────────────────────────────────────────┘
     ↑                                    ↑
  点击→页面19 VIP中心              点击→页面21 消息中心
```

### 3.3 VIP 徽章（左侧）

| 属性 | 实现 |
| --- | --- |
| **数据来源** | `useAuth` → `user.vipLevel`（0~7） |
| **配色** | 按 VIP 等级映射色（`1-1 §3.9`）：VIP0 铜色 `#CD7F32` → VIP7 钻石渐变 |
| **尺寸** | `28×28px` 圆形 `rounded-radius-full` |
| **金属质感** | `background: linear-gradient(135deg, ...)` 对称双向渐变（`1-1 §3.9 .vip-badge`） |
| **发光** | `box-shadow: 0 0 20px rgba(201,168,76,0.3)`（金色光晕） |
| **文字** | 徽章内数字 `text-[10px] font-bold text-text-primary` |
| **右侧** | 徽章旁显示 `VIP{level}` 文字 `text-caption font-medium text-gold` |
| **交互** | 点击导航至 `/vip`（页面 19 VIP 中心） |

### 3.4 消息角标（右侧）

| 属性 | 实现 |
| --- | --- |
| **图标** | Lucide `Bell` 24px `text-text-secondary` |
| **角标** | `bg-danger text-white text-[10px] font-bold min-w-[18px] h-[18px] rounded-radius-full` |
| **数字规则** | 未读数 > 0 时显示数字；> 99 显示 `99+`；= 0 时隐藏角标 |
| **数据来源** | `GET /api/notifications/unread-count` + WebSocket `notification:new` 事件实时更新 |
| **脉冲动画** | 有新消息到达时角标 `animate-pulse-glow`（蓝色脉冲 2s 周期），3s 后恢复静态 |
| **交互** | 点击导航至 `/messages`（页面 21 消息中心） |

### 3.5 底部 Tab 红点联动

当未读消息 > 0 时，`BottomNav` 的"我的"Tab 右上角显示 6px 红点（`bg-danger`），与消息角标数据共享同一 `unreadCount` 状态。数据通过 `useWebSocket` 订阅 `notification:new` 事件 + `user:balance_changed` 事件维护。

### 3.6 TopStatusBar 可见性

| 断点 | 行为 |
| --- | --- |
| `< md`（移动端） | 显示在首页内容区顶部，固定在 `PageContainer` 内部 |
| `≥ md`（平板/桌面） | VIP 徽章集成到 `SideNav` 底部用户信息区；消息 `Bell` 图标集成到 `SideNav` 导航项中；`TopStatusBar` 组件 `hidden` |

---

## 四、余额卡片 BalanceCard

### 4.1 组件引用

使用 `BalanceCard`（`1-2 §4.3`），首页视觉绝对主角。

### 4.2 视觉定位

BalanceCard 是首页**最大尺寸、最高视觉权重**的元素：

- **占据首屏黄金位置**：TopStatusBar 下方第一个区块
- **大面积呼吸留白**：卡片内边距 `24px`（`padding="lg"`），卡片圆角 `20px`（`radius="xl"`）
- **3D 纵深感**：`perspective: 1200px`，云端浮卡质感 `shadow-card`
- **双层投影**：`shadow-card` + `shadow-inner-highlight`（黑色深度 + 蓝调氛围光 + 顶部内发光）

### 4.3 3D 翻转机制

BalanceCard 支持 3 个面的 3D 翻转切换：

| 面 | `activeFace` | 显示内容 | 标签文案（CMS 动态） |
| --- | --- | --- | --- |
| **正面（默认）** | `0` | 可用余额 `availableBalance` | `t('home.balance_available')` |
| **第二面** | `1` | 冻结余额 `frozenBalance` | `t('home.balance_frozen')` |
| **第三面** | `2` | 赠金余额 `bonusBalance` | `t('home.balance_bonus')` |

**翻转交互**：

```
用户水平滑动 或 点击底部 3 个小圆点指示器
  → Framer Motion rotateY: 0° → 180° → 360°
  → 翻转时有金属质感光线扫过效果（::after 伪元素，linear-gradient 从左到右扫过 0.5s）
  → perspective: 1200px，transform-style: preserve-3d
  → 缓动: cubic-bezier(0.2, 0, 0, 1)（ease-snappy），duration: 0.6s
```

### 4.4 卡片内部布局

```
┌─────────────────────────────────────────────┐
│  Saldo disponible          [眼睛图标 👁]    │  ← 标签行：text-caption text-text-secondary
│                                             │
│  S/ 1,500.00                                │  ← 余额数字：ParticleNumber
│                                             │     font-mono text-amount-lg font-medium
│                                             │     text-text-primary
│                                             │     text-shadow: 0 0 20px rgba(241,245,249,0.1)
│                                             │
│         ● ○ ○                               │  ← 翻转指示器：3 个小圆点
│    可用    冻结   赠金                        │     当前面实心 accent，其余空心 text-disabled
└─────────────────────────────────────────────┘
```

### 4.5 余额数字动画

- **ParticleNumber 粒子聚合**（`1-2 §8.1`）：余额数值变化时，旧数字粒子化散开（30 个金色粒子，扩散 60px，0.8s），新数字由粒子聚合重组
- **CountUpNumber 数字滚动**（`1-2 §9.3`）：配合 `react-countup`，`duration: 0.8s`，`decimals: 2`，`separator: ","` ，`prefix: "S/ "`
- **触发条件**：WebSocket `user:balance_changed` 事件到达时触发一次，非持续循环
- **低端降级**（`isLowEnd=true`）：禁用粒子效果，仅保留 `CountUpNumber` 数字滚动

### 4.6 余额可见性切换

- 右上角眼睛图标（Lucide `Eye` / `EyeOff` 20px）
- 点击切换：数字显示 ↔ `S/ ****`（4 个星号替代）
- 状态持久化到 `localStorage: home:balance_visible`
- 切换动画：`opacity 1→0→1 0.3s`

### 4.7 数据来源

```typescript
const { available, frozen, bonus, isLoading } = useBalance();
// useBalance Hook（1-2 §15.5）
// - TanStack Query staleTime: 0（永远 stale）
// - WebSocket user:balance_changed 事件触发 invalidateQueries(['balance'])
// - 首页余额区变化时触发 ParticleNumber 动效
```

### 4.8 响应式变体

| 断点 | 行为 |
| --- | --- |
| `< md` | 全宽卡片，左右 margin = 页面安全边距 20px |
| `≥ md` | 固定宽度 `360px`，左对齐 |

---

## 五、今日收益 / 累计收益

### 5.1 数据来源

> **⚠️ API 对齐说明**：`2-4 投资与结算模块` §十五 定义了 `GET /api/investments` 接口，其响应包含 `summary` 汇总字段（`totalDailyIncome`、`totalEarnedAllTime` 等）。本文档假设后端提供独立的收益汇总端点以减少首页数据传输量。若后端不新增此端点，可复用 `GET /api/investments?status=ACTIVE` 响应中的 `summary` 字段。

```
GET /api/investments/earnings-summary
Authorization: Bearer <access_token>

响应：
{
  "code": 0,
  "data": {
    "todayEarnings": "45.00",
    "totalEarnings": "1350.00",
    "todayEarningsCount": 3,
    "activeSummary": {
      "activeCount": 5,
      "totalDailyIncome": "15.00"
    }
  }
}
```

**字段映射**（与 `2-4 §15.3 summary` 对应关系）：

| 本文档字段 | 2-4 §15.3 summary 对应字段 | 说明 |
| --- | --- | --- |
| `todayEarnings` | — | 今日已发放收益总额（需后端新增或前端从 EarningsRecord 聚合） |
| `totalEarnings` | `totalEarnedAllTime` | 历史累计收益 |
| `todayEarningsCount` | — | 今日收益笔数（需后端新增） |
| `activeSummary.activeCount` | `totalActiveInvestments` | 活跃投资数量 |
| `activeSummary.totalDailyIncome` | `totalDailyIncome` | 每日预计总收入 |

### 5.2 布局结构

BalanceCard 下方，两列并排展示：

```
┌──────────────────────┬──────────────────────┐
│  Ganancias de hoy    │  Ganancias totales   │
│  ▲ S/ 45.00          │    S/ 1,350.00       │
└──────────────────────┴──────────────────────┘
     ↑ 今日收益                ↑ 累计收益
```

### 5.3 今日收益视觉规范

| 属性 | 值 |
| --- | --- |
| **标签** | `t('home.today_earnings')` — `text-caption text-text-secondary` |
| **数字** | `font-mono text-amount-md font-medium text-positive` |
| **柔光** | 无（已移除旧版翠绿柔光 text-shadow） |
| **上扬箭头** | 收益 > 0 时，数字左侧显示 Lucide `TrendingUp` 16px `text-positive`，微动画 `translateY(0→-2px→0) 2s ease-in-out infinite` |
| **ParticleNumber** | 数值变化时触发粒子聚合（翠绿色粒子 `#059669`） |
| **收益闪光** | 收益到账瞬间触发 `animate-earning-flash`（`text-shadow 0.6s` 一次性闪烁） |

### 5.4 累计收益视觉规范

| 属性 | 值 |
| --- | --- |
| **标签** | `t('home.total_earnings')` — `text-caption text-text-secondary` |
| **数字** | `font-mono text-amount-md font-medium text-text-primary` |
| **无柔光** | 累计收益为辅助信息，不加 text-shadow |
| **CountUpNumber** | 数值变化时使用 `CountUpNumber`（无粒子效果，区分于今日收益的高亮级别） |

### 5.5 容器样式

```tsx
<div className="flex gap-4">
  <GlassCard padding="md" className="flex-1">
    {/* 今日收益 */}
  </GlassCard>
  <GlassCard padding="md" className="flex-1">
    {/* 累计收益 */}
  </GlassCard>
</div>
```

间距：与 BalanceCard 的区块间距 `32px`（`gap-8`），两卡片内部间距 `16px`（`gap-4`）。

---

## 六、VIP0 每日领取按钮

### 6.1 显示条件

| 条件 | 来源 | 说明 |
| --- | --- | --- |
| `user.vipLevel === 0` | `useAuth` → `GET /api/auth/me` | 仅 VIP0 用户显示 |
| `user.vip0Stopped === false` | VIP 状态 API（见下方说明） | VIP0 奖励未停止（未升级） |
| 当前日期 ∈ `[vip0StartDate, vip0EndDate)` | VIP 状态 API → 前端计算 | VIP0 周期内 |

**以上三个条件全部满足时显示本区块**，否则区块隐藏（`AnimatePresence` 平滑收缩退出）。

> **✅ 数据来源已确认**：VIP0 专属字段（`isVip0`、`stopped`、`canClaimToday`、`remainingDays`、`lastClaimedDate`）由 `GET /api/vip/status` 响应的 `vip0` 嵌套对象提供（`2-8 §14.1`）。前端首页通过 `useVipStatus` Hook（基于 TanStack Query，staleTime 2min）获取此数据。`vipLevel` 仍由 `GET /api/auth/me` 返回。

### 6.2 三种状态

| 状态 | 判定条件 | 视觉表现 |
| --- | --- | --- |
| **可领取** | 今日未领取（`vip0LastClaimedDate ≠ today`） | `PulseGlow active color="gold"` 金色脉冲光晕 + `GoldButton` 香槟金按钮 |
| **已领取** | 今日已领取（`vip0LastClaimedDate === today`） | 按钮灰色禁用，文案 `t('home.vip0_claimed')` + Lucide `CheckCircle` 图标 |
| **已过期** | 当前日期 ≥ `vip0EndDate` | 区块隐藏 |

### 6.3 可领取态布局

```
┌─────────────────────────────────────────────┐
│  ✦ VIP0 — 每日奖励                          │
│                                             │
│     [  S/ 1.00 · Reclamar ahora  ]          │  ← GoldButton + PulseGlow 金色脉冲
│                                             │
│  Quedan 25 días                              │  ← 剩余天数 text-caption text-text-secondary
└─────────────────────────────────────────────┘
```

### 6.4 PulseGlow 脉冲光晕

```tsx
<PulseGlow active={canClaim} color="gold">
  <GoldButton onClick={handleClaimVip0} loading={isClaiming}>
    {`S/ ${vip0DailyReward} · ${t('home.vip0_claim_btn')}`}
  </GoldButton>
</PulseGlow>
```

- 金色光晕 `box-shadow: 0 0 0 0 → 0 0 0 12px rgba(201,168,76,0.4) → 0 0 0 0`
- 周期 2s，`ease-in-out infinite`（`1-2 §8.3`）
- `active=false` 时停止动画节省 GPU

### 6.5 点击领取流程

```
用户点击 → GoldButton 进入 loading 态（防重复 §7.17）
  → POST /api/vip/claim-daily
  → 成功：
    ① Toast.success(`¡S/ 1.00 reclamado!`)
    ② 微型金币雨（CoinRain playing=true duration=2000）
    ③ 按钮切换为"已领取"灰色态
    ④ invalidateQueries(['balance'])（余额刷新触发 ParticleNumber）
  → 失败：
    Toast.error(错误信息)
    按钮恢复可点击
```

### 6.6 CoinRain 微型金币雨

领取成功后播放 `CoinRain`（`1-2 §8.2`）：

| 属性 | 值 |
| --- | --- |
| **粒子颜色** | `#F59E0B`（香槟金） |
| **粒子数量** | 25（首页场景减半，节省性能） |
| **持续时间** | 2000ms |
| **覆盖范围** | `fixed inset-0 z-40 pointer-events-none` |
| **低端降级** | 粒子减为 12 |

---

## 七、快捷入口网格

### 7.1 数据来源

快捷入口由**后台首页布局 API 动态配置**（`2-16 §八`）：

```typescript
// GET /api/config/client → data.homeLayout.quickEntries
// 返回有序数组，如：["recharge", "withdraw", "invite", "earnings_calendar"]
```

管理员从 8 个可选池中选择 **3~6 个**入口展示。

### 7.2 可选入口池

| 标识 | 图标（Lucide） | 默认文案（CMS） | 跳转路由 | 关联全局开关 |
| --- | --- | --- | --- | --- |
| `recharge` | `Wallet` | `t('home.entry_recharge')` | `/recharge`（页面 13） | `rechargeEnabled` |
| `withdraw` | `Banknote` | `t('home.entry_withdraw')` | `/withdraw`（页面 14） | `withdrawEnabled` |
| `invite` | `UserPlus` | `t('home.entry_invite')` | `/team`（页面 8） | `inviteEnabled` |
| `earnings_calendar` | `Calendar` | `t('home.entry_earnings')` | `/earnings-calendar`（页面 12） | — |
| `vip_center` | `Crown` | `t('home.entry_vip')` | `/vip`（页面 19） | — |
| `weekly_tasks` | `Trophy` | `t('home.entry_tasks')` | `/weekly-tasks`（页面 20） | — |
| `products` | `Package` | `t('home.entry_products')` | `/products`（页面 6） | `investmentEnabled` |
| `customer_service` | `Headphones` | `t('home.entry_cs')` | `/customer-service`（页面 4） | — |

### 7.3 网格布局

```
移动端（< md）：3 列或自适应
┌─────────┬─────────┬─────────┐
│  💰     │  💵     │  👥     │
│ Recargar│ Retirar │ Invitar │
├─────────┼─────────┼─────────┤
│  📅     │         │         │
│Ganancias│         │         │
└─────────┴─────────┴─────────┘

平板/桌面（≥ md）：单行横排
┌────────┬────────┬────────┬────────┐
│Recargar│ Retirar│ Invitar│Ganancias│
└────────┴────────┴────────┴────────┘
```

**Tailwind 类**：

```tsx
<div className="grid grid-cols-3 sm:grid-cols-4 md:flex md:flex-row gap-4">
  {quickEntries.map(entry => (
    <QuickEntryItem key={entry.id} entry={entry} />
  ))}
</div>
```

### 7.4 单个入口项样式

```tsx
<GlassCard
  padding="sm"
  interactive
  onClick={() => handleEntryClick(entry)}
  className="flex flex-col items-center gap-2 py-4"
>
  <div className="w-[48px] h-[48px] rounded-radius-md bg-accent/8 flex items-center justify-center">
    <EntryIcon size={24} className="text-accent" />
  </div>
  <span className="text-caption font-medium text-text-primary text-center">
    {entry.label}
  </span>
</GlassCard>
```

### 7.5 全局开关禁用态

当对应全局开关关闭时（`useGlobalSwitch` Hook，`1-2 §15.9`）：

| 视觉表现 | 实现 |
| --- | --- |
| **灰色蒙版** | `opacity-40 grayscale` |
| **微抖动** | 点击时 `animate-shake`（左右抖动 3 次 0.3s） |
| **Toast 提示** | `Toast.warning(t('switch_prompts.{功能}_disabled'))` — 提示关闭原因（CMS 动态文案） |
| **不可导航** | `onClick` 被拦截，不执行路由跳转 |

```typescript
// shake 动画定义
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-4px); }
  40%, 80% { transform: translateX(4px); }
}
```

---

## 八、活跃投资概览

### 8.1 区块可见性

由后台配置控制：`homeLayout.activeInvestmentOverviewVisible`（`2-16 §八.1`）。

- `true` → 显示区块
- `false` → 区块隐藏（`AnimatePresence` 平滑收缩，`height auto→0 + opacity 1→0 0.3s`）
- 用户无活跃投资时 → 显示 `EmptyState`（空卫星插画 + "还没有投资" + CTA "去看看产品"）

### 8.2 数据来源

```
GET /api/investments?status=ACTIVE&page=1&pageSize=3&sortBy=nextSettlementTime&sortOrder=asc
```

取最近即将结算的 3 笔活跃投资，展示缩略信息。

### 8.3 汇总统计行

> **依据**：`开发文档 §10.2` 要求首页活跃投资概览展示**当前持有产品数量**、**最近一笔收益时间**、**今日已发放收益笔数**。

区块标题行下方首先展示一行汇总统计：

```
┌─────────────────────────────────────────────┐
│  Inversiones activas                   ▸    │
│  3 productos · Último: 15:01 · Hoy: 5      │  ← 汇总统计行
│  ↑ 持有数量    ↑ 最近收益时间   ↑ 今日笔数    │     text-caption text-text-secondary
└─────────────────────────────────────────────┘
```

数据来源：`GET /api/investments?status=ACTIVE` 响应中的 `summary.totalActiveInvestments`（持有数量）、列表中最新 `nextSettlementTime`（最近收益时间）、`GET /api/investments/earnings-summary` 中的 `todayEarningsCount`（今日笔数）。

### 8.4 投资列表布局

汇总行下方展示最近即将结算的 3 笔活跃投资缩略卡片：

```
┌─────────────────────────────────────────────┐
│  Inversiones activas                   ▸    │  ← 区块标题 + "查看全部"箭头
├─────────────────────────────────────────────┤
│  ┌──────┐  BAE-E · Ciber               │
│  │ ⭕   │  S/ 9.00/día · 45/80 días     │  ← ProgressRing 48px + 产品信息
│  │ 56%  │  Próximo: 15:01               │
│  └──────┘                               │
├─────────────────────────────────────────────┤
│  ┌──────┐  BAE-B · Tierra               │
│  │ ⭕   │  S/ 1.50/día · 12/30 días     │
│  │ 40%  │  Próximo: 10:30               │
│  └──────┘                               │
├─────────────────────────────────────────────┤
│  ┌──────┐  BAE-A · Aire                 │
│  │ ⭕   │  S/ 1.66/día · 8/15 días      │
│  │ 53%  │  Próximo: 09:45               │
│  └──────┘                               │
└─────────────────────────────────────────────┘
```

### 8.5 ProgressRing 环形进度条

使用 `ProgressRing`（`1-2 §9.2`）：

| 属性 | 值 |
| --- | --- |
| **尺寸** | `size={48}` |
| **环粗** | `strokeWidth={5}` |
| **颜色** | `color="accent"`（平流层蓝） |
| **进度值** | `(settledPeriods / totalPeriods) × 100` |
| **中心文字** | 百分比 `text-[10px] font-mono font-medium text-text-primary` |
| **动画** | Framer Motion `animate={{ strokeDashoffset }}` `duration: 0.6s ease-snappy` |

### 8.6 投资项信息

每行投资项内容：

| 信息 | 样式 | 说明 |
| --- | --- | --- |
| **产品名** | `text-h3 font-semibold text-text-primary` | 如 `BAE-E` |
| **产品标题** | `text-caption text-text-secondary` | 如 `Ciber`（CMS 西班牙语标题） |
| **日收入** | `font-mono text-amount-sm text-positive` | `S/ 9.00/día` |
| **进度** | `text-caption text-text-secondary` | `45/80 días` |
| **下次结算** | `text-caption text-text-secondary` | `Próximo: 15:01` |

### 8.7 交互

- 点击区块标题右侧 `ChevronRight` 箭头 → 导航至 `/investments`（页面 11）
- 点击单个投资项 → 导航至 `/investments/{id}` 投资详情

### 8.8 空状态

```tsx
<EmptyState
  illustrationUrl="/assets/illustrations/satellite.svg"
  title={t('home.no_investments_title')}
  description={t('home.no_investments_desc')}
  actionText={t('home.no_investments_cta')}
  onAction={() => navigate('/products')}
/>
```

---

## 九、滚动公告栏

### 9.1 区块可见性

由后台配置控制：`homeLayout.scrollAnnouncementVisible`（`2-16 §八.1`）。

### 9.2 数据来源

两种数据混合展示（`2-13 §七.4`）：

```typescript
// 1. 滚动公告（CMS 后台配置）
// GET /api/cms/announcements?type=SCROLL

// 2. 中奖/充值/提现/收益播报（虚假 + 真实混合）
// GET /api/cms/broadcasts?limit=20
```

前端将两种数据**混合**为统一的滚动列表，按时间倒序排列。前端**不区分**真假。

**活动开关联动过滤**（`补充一 S1.1/S1.2`）：

| 开关状态 | 滚动公告栏过滤规则 |
| --- | --- |
| **活动 1（奖池）OFF** | 隐藏所有 `WIN_PRIZE` 类型播报（真实 + 虚假），仅保留其他类型 |
| **活动 3（转盘）OFF** | 隐藏所有转盘相关中奖播报 |
| **两者同时 OFF** | 仅保留 `RECHARGE`/`WITHDRAW`/`EARNINGS` 类型播报 + `SCROLL` 公告 |

过滤在前端完成：`useMemo` 根据 `useGlobalSwitch` 的活动开关状态过滤播报列表。

### 9.3 滚动动画规范

| 属性 | 值 |
| --- | --- |
| **容器高度** | `40px`（单行文字） |
| **滚动方向** | 纵向（从下往上滚入） |
| **单条展示** | 每次展示一条，`4s` 后切换下一条 |
| **切换动画** | 当前条 `translateY(0)→translateY(-100%) + opacity 1→0 0.3s`，下一条 `translateY(100%)→translateY(0) + opacity 0→1 0.3s` |
| **循环** | 到达列表末尾后回到第一条，无缝循环 |
| **暂停** | 用户触摸/hover 时暂停滚动 |

### 9.4 单条播报样式

```
┌─────────────────────────────────────────────┐
│  🏆 Usuario U3521 ganó S/ 200 en el sorteo  │
└─────────────────────────────────────────────┘
```

| 元素 | 样式 |
| --- | --- |
| **图标** | 根据类型显示不同 Lucide 图标：`Trophy`（中奖）/ `ArrowUpCircle`（充值）/ `ArrowDownCircle`（提现）/ `TrendingUp`（收益），16px `text-gold` |
| **文字** | `text-caption text-text-secondary`，单行截断 `truncate` |
| **容器** | `bg-card/50 backdrop-blur-[20px] rounded-radius-sm px-4` |

### 9.5 公告条内容

滚动公告（`SCROLL` 类型）前面加 Lucide `Megaphone` 16px `text-accent` 图标，文字 `text-caption text-text-primary`（比播报文字亮一级，区分优先级）。

---

## 十、WebSocket 余额实时刷新

### 10.1 连接管理

使用 `useWebSocket` Hook（`1-2 §15.6`）：

| 属性 | 值 |
| --- | --- |
| **连接时机** | 用户认证后自动连接 |
| **断线重连** | 指数退避 `1s→2s→4s→8s→16s→30s`（最大 30s） |
| **心跳** | 每 30s 发送 `ping`，60s 无 `pong` 视为断连 |
| **断线兜底** | WebSocket 断连期间，回退到 **30s 轮询** `GET /api/config/version`，版本号变化时批量失效缓存 |

### 10.2 余额更新事件流

```
后端余额变动
  → WebSocket 推送 user:balance_changed
    payload: {
      userId,
      availableBalance: "1545.00",
      frozenBalance: "100.00",
      bonusBalance: "0.00",
      changeType: "EARNINGS",
      changeAmount: "45.00",
      timestamp: 1739512800
    }
  → 前端 useWebSocket.subscribe('user:balance_changed', handler)
    → handler:
      ① queryClient.invalidateQueries(['balance'])
      ② 触发 BalanceCard 的 ParticleNumber 粒子聚合动画
      ③ 如果 changeType 是收益类（EARNINGS/VIP_COMMISSION/TEAM_CASHBACK）
         → 同时刷新今日收益/累计收益数字
         → 今日收益触发 animate-earning-flash 绿色闪光
```

### 10.3 首页订阅的全部 WebSocket 事件

| 事件 | 前端响应 |
| --- | --- |
| `user:balance_changed` | 刷新余额三字段 + 收益数字 + ParticleNumber 动画 |
| `notification:new` | 消息角标 +1 + 角标脉冲动画 |
| `config:global_switch_changed` | 检查快捷入口禁用态，更新 useGlobalSwitch |
| `config:maintenance_on` | 全屏维护页覆盖（`MaintenancePage`） |
| `config:maintenance_off` | 关闭维护页，恢复正常 |
| `config:announcement_changed` | 刷新滚动公告栏 + 弹窗队列 |
| `config:activity_changed` | 刷新活动相关开关状态 |
| `user:banned` | 弹出封禁提示页 → 强制登出 |

### 10.4 断线兜底轮询

```typescript
// useConfigVersion Hook（2-16 §十二.4）
// 每 30s 轮询 GET /api/config/version
// 版本号变化 → queryClient.invalidateQueries() 批量失效所有缓存
// 确保 WebSocket 断线期间用户仍能在 ≤ 30s 内感知配置变化
```

---

## 十一、区块可见性控制逻辑

### 11.1 后台可配区块

| 区块 | 控制方式 | 配置键 | 默认值 |
| --- | --- | --- | --- |
| **VIP0 每日领取** | 前端条件判定 | — | VIP0 用户 + 周期内显示 |
| **快捷入口网格** | 始终显示（入口内容可配） | `home_quick_entries` | 4 个默认入口 |
| **活跃投资概览** | 后台开关 | `home_active_investment_visible` | `true` |
| **滚动公告栏** | 后台开关 | `home_scroll_announcement_visible` | `true` |

### 11.2 隐藏时平滑收缩动画

所有可隐藏区块均使用 `Framer Motion AnimatePresence` 包裹：

```tsx
<AnimatePresence mode="sync">
  {isVisible && (
    <motion.div
      key="section-name"
      initial={{ opacity: 0, height: 0, marginBottom: 0 }}
      animate={{ opacity: 1, height: 'auto', marginBottom: 32 }}
      exit={{ opacity: 0, height: 0, marginBottom: 0 }}
      transition={{ duration: 0.3, ease: [0.2, 0, 0, 1] }}
    >
      {/* 区块内容 */}
    </motion.div>
  )}
</AnimatePresence>
```

### 11.3 实时响应

后台修改区块可见性 → `PUT /api/admin/config/:key` → WebSocket `config:global_switch_changed` 或版本号变化 → 前端 `useGlobalSwitch` / TanStack Query 缓存失效 → 区块平滑显现/收缩。

---

## 十二、完整组件树与数据流架构

### 12.1 组件树结构

```
ResponsiveShell
├── SideNav (hidden < md)
├── BottomNav (md:hidden)
│   └── UnreadDot (消息未读红点)
└── PageContainer (hasBottomNav)
    └── HomePage
        ├── TopStatusBar                    ← VIP 徽章 + 消息角标
        │   ├── VipBadge                    ← useAuth → vipLevel
        │   └── NotificationBell            ← GET /api/notifications/unread-count + WS
        │
        ├── PopupQueue                      ← 弹窗排队系统（usePopupQueue）
        │   ├── AnnouncementPopup (P1)      ← GET /api/cms/announcements?type=DAILY_POPUP
        │   └── DiscountPopup (P2)          ← config.discountPopupEnabled + products
        │
        ├── BalanceCard                     ← useBalance（WS user:balance_changed）
        │   ├── ParticleNumber              ← 余额数字粒子聚合
        │   ├── CountUpNumber               ← 数字滚动
        │   └── FlipIndicator               ← 3 面翻转指示器
        │
        ├── EarningsRow                     ← GET /api/investments/earnings-summary
        │   ├── TodayEarnings               ← ParticleNumber + TrendingUp 箭头
        │   └── TotalEarnings               ← CountUpNumber
        │
        ├── Vip0ClaimSection                ← useAuth + POST /api/vip/claim-daily
        │   ├── PulseGlow                   ← 金色脉冲
        │   ├── GoldButton                  ← 领取按钮
        │   └── CoinRain                    ← 领取成功金币雨
        │
        ├── QuickEntryGrid                  ← config.homeLayout.quickEntries
        │   └── QuickEntryItem × 3~6        ← useGlobalSwitch 禁用态
        │
        ├── ActiveInvestmentOverview        ← GET /api/investments?status=ACTIVE
        │   ├── SectionHeader               ← 标题 + "查看全部"
        │   └── InvestmentItem × 3          ← ProgressRing + 投资信息
        │       └── ProgressRing (48px)
        │
        └── ScrollAnnouncementBar           ← GET /api/cms/broadcasts + announcements
            └── ScrollItem × N              ← 纵向渐入渐出轮播
```

### 12.2 数据流架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          首页数据流                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐     ┌──────────────┐     ┌──────────────────┐    │
│  │ WebSocket│     │ TanStack     │     │ localStorage     │    │
│  │ 实时推送  │     │ Query 缓存   │     │ 本地持久化        │    │
│  └────┬─────┘     └──────┬───────┘     └────────┬─────────┘    │
│       │                  │                      │              │
│  ┌────▼──────────────────▼──────────────────────▼──────────┐   │
│  │                    React State                           │   │
│  │  ┌─────────┐ ┌──────────┐ ┌────────┐ ┌──────────────┐  │   │
│  │  │useBalance│ │useAuth   │ │useGlobal│ │useWebSocket  │  │   │
│  │  │余额三字段│ │用户+VIP  │ │Switch   │ │连接管理      │  │   │
│  │  └────┬────┘ └────┬─────┘ └───┬────┘ └──────┬───────┘  │   │
│  └───────┼───────────┼───────────┼─────────────┼──────────┘   │
│          │           │           │             │               │
│  ┌───────▼───────────▼───────────▼─────────────▼──────────┐   │
│  │                    UI 组件渲染                           │   │
│  │  BalanceCard → EarningsRow → VIP0 → QuickEntry → ...   │   │
│  └────────────────────────────────────────────────────────┘   │
│                                                                 │
│  事件流：                                                        │
│  user:balance_changed → invalidate(['balance']) → ParticleNumber │
│  notification:new     → unreadCount++ → Bell 角标脉冲           │
│  config:*_changed     → invalidate(['config']) → UI 响应        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 12.3 API 调用清单

| API | 时机 | 缓存策略 | 说明 |
| --- | --- | --- | --- |
| `GET /api/auth/me` | 首页 mount | `staleTime: 0`, WS 驱动 | 用户信息 + 余额 |
| `GET /api/investments/earnings-summary` | 首页 mount | `staleTime: 1min`, WS `user:balance_changed` 触发刷新 | 今日/累计收益 |
| `GET /api/investments?status=ACTIVE` | 首页 mount | `staleTime: 2min`, 手动 refetch | 活跃投资列表 |
| `GET /api/config/client` | App 启动 | `staleTime: 30s`, WS + 版本号轮询 | 全局配置（开关/快捷入口/布局） |
| `GET /api/cms/announcements?type=DAILY_POPUP` | 首页 mount | `staleTime: 5min`, WS `config:announcement_changed` | 每日弹窗公告 |
| `GET /api/cms/announcements?type=SCROLL` | 首页 mount | `staleTime: 5min`, WS `config:announcement_changed` | 滚动公告 |
| `GET /api/cms/broadcasts` | 首页 mount | `staleTime: 2min` | 虚假 + 真实播报 |
| `GET /api/notifications/unread-count` | 首页 mount | `staleTime: 0`, WS `notification:new` | 消息未读数 |
| `POST /api/vip/claim-daily` | 用户点击 | — | VIP0 每日领取 |
| `GET /api/config/version` | 每 30s 轮询 | 无缓存 | 版本号兜底 |

---

## 十三、响应式布局策略

### 13.1 断点布局总览

遵循 `1-1 §3.8.4 (c) 首页`：

| 断点 | 布局 |
| --- | --- |
| `< md`（< 768px） | **单栏纵向**：余额卡片 → 收益 → VIP0 → 快捷入口 → 投资概览 → 公告 |
| `≥ md`（768px ~ 1023px） | **双栏**：左栏（余额卡片 + 收益 + 快捷入口）；右栏（投资概览 + 公告） |
| `≥ lg`（≥ 1024px） | **三栏**：左栏资产（余额 + 收益）；中栏功能入口（快捷入口 + VIP0）；右栏动态信息（投资概览 + 公告） |

### 13.2 移动端布局（< 768px）

```
┌──────────────────────────────┐
│  TopStatusBar                │  ← VIP 徽章 + 消息角标
│  ┌────────────────────────┐  │
│  │    BalanceCard (全宽)   │  │  ← 3D 翻转，max-w-[400px]
│  └────────────────────────┘  │
│  ┌──────────┬──────────────┐ │
│  │今日收益   │ 累计收益      │ │  ← 两列并排
│  └──────────┴──────────────┘ │
│  ┌────────────────────────┐  │
│  │ VIP0 每日领取（条件显示） │ │
│  └────────────────────────┘  │
│  ┌────┬────┬────┐            │
│  │ 充值│ 提现│ 邀请│            │  ← 快捷入口 3 列网格
│  ├────┼────┼────┤            │
│  │ 收益│    │    │            │
│  └────┴────┴────┘            │
│  ┌────────────────────────┐  │
│  │ 活跃投资概览 (3 笔)      │ │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │ 滚动公告栏               │ │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │    BottomNav (5 Tab)    │ │
│  └────────────────────────┘  │
└──────────────────────────────┘
```

### 13.3 平板端布局（768px ~ 1023px）

```
┌──────────────────────────────────────────────┐
│ SideNav│   左栏                │  右栏         │
│ 72px   │  ┌──────────────┐   │ ┌──────────┐ │
│        │  │ BalanceCard   │   │ │投资概览   │ │
│ (折叠)  │  └──────────────┘   │ │          │ │
│        │  ┌──────┬───────┐   │ │ 3笔列表   │ │
│        │  │今日   │ 累计   │   │ │          │ │
│        │  └──────┴───────┘   │ └──────────┘ │
│        │  ┌──────────────┐   │ ┌──────────┐ │
│        │  │VIP0 领取      │   │ │滚动公告   │ │
│        │  └──────────────┘   │ └──────────┘ │
│        │  ┌──────────────┐   │              │
│        │  │快捷入口 4 列   │   │              │
│        │  └──────────────┘   │              │
└──────────────────────────────────────────────┘
```

### 13.4 桌面端布局（≥ 1024px）

```
┌──────────────────────────────────────────────────────────┐
│ SideNav │  左栏（资产）   │  中栏（功能）   │  右栏（动态）  │
│ 240px   │ BalanceCard    │ 快捷入口 2×2   │ 投资概览      │
│ (展开)   │ 360px 左对齐   │ VIP0 领取      │ 滚动公告      │
│         │ 今日/累计收益   │                │              │
└──────────────────────────────────────────────────────────┘
```

### 13.5 间距响应式

| 间距项 | 移动端 (< md) | 平板 (md ~ lg) | 桌面 (≥ lg) |
| --- | --- | --- | --- |
| 页面左右安全边距 | `20px` | `32px` | `40px` |
| 区块间距 | `32px` | `40px` | `48px` |
| 卡片间距 | `16px` | `20px` | `24px` |
| BalanceCard 内边距 | `24px` | `28px` | `32px` |

Tailwind 写法：`px-5 md:px-8 lg:px-10`、`gap-8 md:gap-10 lg:gap-12`

---

## 十四、骨架屏与加载策略

### 14.1 首屏骨架屏

首页打开时，数据未到达前展示骨架屏（`1-2 §12.1`）：

```
┌──────────────────────────────┐
│  [●] VIP?               [🔔]│  ← 骨架：圆形 28px + 矩形 60px
├──────────────────────────────┤
│  ┌────────────────────────┐  │
│  │ ████████████████████   │  │  ← Skeleton.BalanceCard
│  │ ██████████             │  │     全宽 h-[180px] rounded-xl
│  │                        │  │     animate-shimmer
│  └────────────────────────┘  │
│  ┌──────────┬──────────────┐ │
│  │ ██████   │ ██████████   │ │  ← Skeleton 收益区
│  └──────────┴──────────────┘ │
│  ┌────┬────┬────┐            │
│  │ ██ │ ██ │ ██ │            │  ← Skeleton 快捷入口
│  └────┴────┴────┘            │
│  ┌────────────────────────┐  │
│  │ ████████████████       │  │  ← Skeleton 投资概览
│  │ ██████████████████     │  │
│  └────────────────────────┘  │
└──────────────────────────────┘
```

### 14.2 骨架屏实现

```tsx
function HomePageSkeleton() {
  return (
    <div className="flex flex-col gap-8 px-5 md:px-8 lg:px-10 py-6">
      {/* TopStatusBar 骨架 */}
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-2">
          <Skeleton className="w-7 h-7 rounded-full" />
          <Skeleton className="w-12 h-4 rounded-radius-sm" />
        </div>
        <Skeleton className="w-6 h-6 rounded-radius-sm" />
      </div>

      {/* BalanceCard 骨架 */}
      <Skeleton className="w-full h-[180px] rounded-radius-xl" />

      {/* 收益区骨架 */}
      <div className="flex gap-4">
        <Skeleton className="flex-1 h-[80px] rounded-radius-lg" />
        <Skeleton className="flex-1 h-[80px] rounded-radius-lg" />
      </div>

      {/* 快捷入口骨架 */}
      <div className="grid grid-cols-3 gap-4">
        {Array.from({ length: 3 }).map((_, i) => (
          <Skeleton key={i} className="h-[80px] rounded-radius-md" />
        ))}
      </div>

      {/* 投资概览骨架 */}
      <div className="flex flex-col gap-3">
        <Skeleton className="w-32 h-5 rounded-radius-sm" />
        {Array.from({ length: 3 }).map((_, i) => (
          <Skeleton key={i} className="h-[64px] rounded-radius-md" />
        ))}
      </div>
    </div>
  );
}
```

### 14.3 加载策略

| 策略 | 实现 | 说明 |
| --- | --- | --- |
| **骨架屏** | 首页首次加载（所有查询 `isLoading=true`）→ 显示 `HomePageSkeleton` | 避免白屏闪烁 |
| **渐进渲染** | 各区块独立查询，数据到达即渲染，未到达的区块保持单独骨架 | 不阻塞整体渲染 |
| **缓存优先** | TanStack Query `staleTime` 保证二次进入直接命中缓存 | 秒开体验 |
| **WS 增量更新** | WebSocket 事件触发精准失效，非全量刷新 | 最小化网络请求 |
| **下拉刷新** | 下拉触发所有首页查询 `refetchAll()`，同时显示 `RefreshIndicator` | 用户主动刷新 |

### 14.4 下拉刷新

```tsx
<PullToRefresh
  onRefresh={async () => {
    await Promise.all([
      queryClient.refetchQueries({ queryKey: ['balance'] }),
      queryClient.refetchQueries({ queryKey: ['earnings-summary'] }),
      queryClient.refetchQueries({ queryKey: ['investments', 'active'] }),
      queryClient.refetchQueries({ queryKey: ['config', 'client'] }),
      queryClient.refetchQueries({ queryKey: ['notifications', 'unread-count'] }),
    ]);
  }}
  threshold={80}
  indicatorColor="accent"
>
  {/* 首页内容 */}
</PullToRefresh>
```

---

## 十五、性能预算

### 15.1 首页性能指标

| 指标 | 目标 | 测量方式 |
| --- | --- | --- |
| **FCP（首次内容绘制）** | < 1.5s | Lighthouse |
| **LCP（最大内容绘制）** | < 2.5s（BalanceCard 区域） | Lighthouse |
| **CLS（累计布局偏移）** | < 0.1 | 骨架屏预占空间 |
| **首屏 API 并发** | ≤ 6 个（批量请求） | Network 面板 |
| **JS Bundle（首页路由）** | < 80KB gzipped | Webpack analyzer |
| **首屏渲染帧率** | ≥ 55fps | Performance 面板 |

### 15.2 动画性能控制

| 动画 | GPU 加速 | 低端降级 |
| --- | --- | --- |
| **ParticleNumber** | Canvas 绘制，独立图层 | `isLowEnd` → 禁用粒子，仅 CountUpNumber |
| **3D 翻转** | `transform: rotateY()` + `will-change: transform` | `isLowEnd` → 改为 2D `opacity` 淡入淡出 |
| **PulseGlow** | `box-shadow` 动画 | `isLowEnd` → 静态边框替代 |
| **CoinRain** | Canvas 绘制 | `isLowEnd` → 粒子减半 12 |
| **滚动公告** | `transform: translateY()` | 不降级（开销极小） |

### 15.3 设备检测

```typescript
// useDeviceCapability Hook（1-2 §15.10）
const { isLowEnd } = useDeviceCapability();
// 判定条件：navigator.hardwareConcurrency ≤ 4 || navigator.deviceMemory ≤ 4
// 低端设备：禁用粒子效果、减少动画复杂度、Canvas 粒子数减半
```

---

## 十六、自检清单

- [ ] 余额三字段（可用/冻结/赠金）通过 BalanceCard 3D 翻转展示？ — §四.3
- [ ] 余额数字使用 ParticleNumber + CountUpNumber 双动画？ — §四.5
- [ ] 余额可见性切换持久化到 localStorage？ — §四.6
- [ ] 今日收益翠绿柔光 + TrendingUp 箭头微动画？ — §五.3
- [ ] VIP0 每日领取三条件全满足才显示？ — §六.1
- [ ] VIP0 领取成功播放 CoinRain + Toast + 余额刷新？ — §六.5
- [ ] 快捷入口由后台动态配置（3~6 个）？ — §七.1
- [ ] 快捷入口关联全局开关禁用态（灰色 + 抖动 + Toast）？ — §七.5
- [ ] 活跃投资概览包含汇总统计行（持有数/最近收益时间/今日笔数）？ — §八.3
- [ ] 活跃投资概览使用 ProgressRing 48px？ — §八.5
- [ ] 滚动公告栏混合公告 + 播报数据？ — §九.2
- [ ] 滚动公告栏按活动开关过滤播报类型（S1.1/S1.2）？ — §九.2
- [ ] VIP0 数据来源已明确（/api/auth/me 扩展或 /api/vip/status）？ — §六.1
- [ ] 收益汇总 API 字段与 2-4 §15.3 summary 对齐？ — §五.1
- [ ] WebSocket 8 种事件全部订阅？ — §十.3
- [ ] WebSocket 断线时 30s 轮询兜底？ — §十.4
- [ ] 弹窗优先级排队：P1 每日公告 → P2 折扣弹窗？ — §二.1
- [ ] 弹窗每日判重（localStorage key）？ — §二.2
- [ ] 区块隐藏时 AnimatePresence 平滑收缩？ — §十一.2
- [ ] 首页骨架屏各区块独立占位？ — §十四.1
- [ ] 下拉刷新触发所有查询 refetchAll？ — §十四.4
- [ ] 低端设备粒子效果降级？ — §十五.2
- [ ] 移动端/平板/桌面三断点布局正确？ — §十三.1
- [ ] 消息角标 > 99 显示 99+ ？ — §三.4
- [ ] VIP 徽章按等级映射色？ — §三.3
- [ ] 金额字段 JSON 中以 string 传输（`0-4 §五.4`）？
- [ ] 所有组件引用与 `1-2 前端共享组件库` 对齐？
- [ ] 所有 API 路径与后端模块文档对齐？

---

## 十七、交叉验证记录

> 本章节记录 3-5 文档与基础文档的交叉验证结果，供开发者参考。

### 17.1 与 1-1 视觉设计语言文档的对齐

| 验证项 | 结果 | 说明 |
| --- | --- | --- |
| 色彩 Token 引用 | ✅ | `text-positive`/`text-text-primary`/`text-text-secondary`/`bg-card` 等全部使用语义化 Token |
| 字体阶梯 | ✅ | `text-amount-lg` 28px / `text-amount-md` 20px / `text-h3` 16px / `text-caption` 12px |
| 动画缓动 | ✅ | `ease-snappy` cubic-bezier(0.2,0,0,1) 用于翻转/进度条 |
| VIP 等级配色映射 | ✅ | §三.3 引用 `1-1 §3.9` VIP 等级色系 |
| 响应式断点 | ✅ | `< md` / `≥ md` / `≥ lg` 三级断点一致 |

### 17.2 与 1-2 前端共享组件库文档的对齐

| 验证项 | 结果 | 说明 |
| --- | --- | --- |
| `BalanceCard` 组件 | ✅ | §四 引用 `1-2 §4.3`，3D 翻转 + ParticleNumber |
| `GlassModal` 组件 | ✅ | §二.3 引用 `1-2 §7.1`，弹窗容器 |
| `GlassCard` 组件 | ✅ | §五.5 / §七.4 引用 `1-2 §4.1` |
| `ProgressRing` 组件 | ✅ | §八.4 引用 `1-2 §9.2` |
| `ParticleNumber` 动效 | ✅ | §四.5 / §五.3 引用 `1-2 §8.1` |
| `PulseGlow` 动效 | ✅ | §六.4 引用 `1-2 §8.3` |
| `CoinRain` 动效 | ✅ | §六.6 引用 `1-2 §8.2` |
| `useBalance` Hook | ✅ | §四.7 引用 `1-2 §15.5` |
| `useWebSocket` Hook | ✅ | §十.1 引用 `1-2 §15.6` |
| `useGlobalSwitch` Hook | ✅ | §七.5 引用 `1-2 §15.9` |

### 17.3 与后端模块文档的对齐

| 验证项 | 结果 | 说明 |
| --- | --- | --- |
| 余额三字段（`2-2`） | ✅ | `availableBalance` / `frozenBalance` / `bonusBalance` |
| 收益汇总 API（`2-4`） | ✅ | `GET /api/investments/earnings-summary` |
| VIP0 每日领取（`2-8`） | ✅ | `POST /api/vip/claim-daily` + VIP0 周期逻辑 |
| 站内信未读数（`2-12`） | ✅ | `GET /api/notifications/unread-count` |
| CMS 公告/播报（`2-13`） | ✅ | `GET /api/cms/announcements` + `GET /api/cms/broadcasts` |
| 全局开关（`2-16 §四`） | ✅ | 6 个开关优先级 + 前端联动规则 |
| 首页布局配置（`2-16 §八`） | ✅ | `quickEntries` + 区块可见性 |
| WebSocket 事件（`2-16 §十一`） | ✅ | 10 种事件枚举 + payload 格式 |
| 版本号轮询（`2-16 §十二`） | ✅ | 30s 轮询 + 8 位 hex hash |

### 17.4 与开发文档主文档的对齐

| 验证项 | 结果 | 说明 |
| --- | --- | --- |
| §10.2 页面 5 首页 | ✅ | 所有子模块全覆盖 |
| 补充一 S1.1~S1.6 活动与功能开关前端隐藏规则 | ✅ | 奖池/转盘 OFF 时滚动公告栏过滤（§九.2）、折扣弹窗双条件（§二.1）、快捷入口禁用态（§七.5） |
| 补充四 S4.8 首页布局管理 | ✅ | 快捷入口可选池 8 项 + 区块可见性 |
